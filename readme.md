# Sparse Matrix Pytorch Extension

## Prerequisites

Before you can compile the PyTorch extension, you need to install the necessary requirements. Run the following command in your terminal:

```bash
pip install -r requirements.txt
```

## Compiling the PyTorch Extension

After installing the prerequisites, navigate to the pytorch_extension directory and run the setup file to compile the PyTorch extension:

```bash
cd pytorch_extension
bash run.sh
```

## Running the Tests

This project uses the pytest module for unit testing. To test the PyTorch extension implementation, run the following command:

```bash
pytest ./test
```

## Benchmark Tool

The main functions for benchmarking are `_benchmark`, `benchmark`, `benchmark_by_config_list`, `generate_benchmark_configurations`, and `show_benchmark_results`.

### _benchmark
This function benchmarks the performance of different SPMM implementations on a single test configuration. It generates two sparse matrices based on the configuration, times the execution of each SPMM implementation, and returns the results.

### benchmark
This function takes a `BenchmarkConfiguration` object and a number of runs as input. It uses `_benchmark` to benchmark the SPMM implementations and returns the results.

### benchmark_by_config_list
This function takes a list of `BenchmarkConfiguration` objects and a number of runs as input. It benchmarks the SPMM implementations for each configuration and returns the results.

### generate_benchmark_configurations
This function generates a list of `BenchmarkConfiguration` objects based on the input size and density ranges.

### show_benchmark_results
This function takes a list of `BenchmarkResult` objects and prints them in a comparative format. The results are expected to be generated by `benchmark_by_config_list`.

### Usage
Please note that the benchmarking process can be time-consuming, especially for larger matrices and higher densities. 

```python
def benchmark_example():
    """
    An example of how to benchmark multiple test configurations.
    """
    from src.benchmark import generate_benchmark_configurations, benchmark_by_config_list, show_benchmark_results
    configs = generate_benchmark_configurations(size_start=5, size_end=500, size_step=50, density_start=1, density_end=10, density_step=4)
    results = benchmark_by_config_list(configs)
    show_benchmark_results(results)
```

## Notes

### pytorch extension include issue

- for those which pytorch built-in function didn't include by torch/extension.h, you need to include the right file like
    ```c++
    at::native::StridedRandomAccessor
    ``` 
    you need to include
    ```c++
    #include <ATen/native/StridedRandomAccessor.h>
    ```

## Reference

- pytorch
    - [pytorch extension](https://pytorch.org/tutorials/advanced/cpp_extension.html)
    - [pytorch SparseTensorMath.cpp](https://github.com/pytorch/pytorch/blob/729ac7317a50a6a195b324cf6cefd748bf4f5498/aten/src/ATen/native/sparse/SparseTensorMath.cpp#L1379)
    - [pytorch NativeFunctions.yaml](https://github.com/pytorch/pytorch/blob/729ac7317a50a6a195b324cf6cefd748bf4f5498/aten/src/ATen/native/native_functions.yaml#L4073)
    - [pytorch SparseMatmul.cpp](https://github.com/pytorch/pytorch/blob/729ac7317a50a6a195b324cf6cefd748bf4f5498/aten/src/ATen/native/sparse/SparseMatMul.cpp#L89)